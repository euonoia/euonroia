name: Monorepo Build & Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-security:
    name: Build & Security
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: [frontend, backend]

    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      # ----------------------------
      # Checkout repository
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Setup Node.js
      # ----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: yarn --cwd ${{ matrix.folder }} install --frozen-lockfile

      # ----------------------------
      # Build project
      # ----------------------------
      - name: Build project
        run: yarn --cwd ${{ matrix.folder }} build

      # ----------------------------
      # Audit dependencies with Yarn
      # ----------------------------
      - name: Audit dependencies
        run: yarn --cwd ${{ matrix.folder }} audit --level moderate

      # ----------------------------
      # Install security tools
      # ----------------------------
      - name: Install security tools
        run: |
          pip install semgrep
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          npm install -g snyk

      # ----------------------------
      # Run Semgrep
      # ----------------------------
      - name: Run Semgrep
        run: semgrep --config=p/ci ${{ matrix.folder }}

      # ----------------------------
      # Run Trivy
      # ----------------------------
      - name: Run Trivy
        run: trivy fs --severity CRITICAL,HIGH,MEDIUM ${{ matrix.folder }}

      # ----------------------------
      # Run Snyk
      # ----------------------------
      - name: Run Snyk
        run: snyk test --all-projects
